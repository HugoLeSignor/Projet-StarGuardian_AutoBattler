{% extends 'base.html.twig' %}

{% block title %}Arena - Combat{% endblock %}

{% block body %}
<div class="arena-container" data-combat-logs="{{ logsJson|e('html_attr') }}"{% if finalizeUrl is defined and finalizeUrl %} data-finalize-url="{{ finalizeUrl }}"{% endif %}>

    {# ========================================== #}
    {# SECTION HAUTE - Zone de combat animations #}
    {# ========================================== #}
    {% set backgrounds = ['cove.jpg', 'warrens.jpg', 'ruins.jpg', 'darkest.jpg', 'arena1.jpg', 'arena2.jpg', 'weald.webp'] %}
    {% set bg = random(backgrounds) %}
    <div class="battle-stage" style="background-image: url('{{ asset('asset/img/backgrounds/' ~ bg) }}');">
        <div class="battle-stage__team battle-stage__team--left">
            {% for member in composition['Equipe 1'] %}
            <div class="battle-stage__character"
                 data-character-name="{{ member.name }}"
                 data-character-team="Equipe 1"
                 data-character-slug="{{ member.name|lower|replace({' ': '-'}) }}"
                 data-has-heal="{{ member.hasHeal ? 'true' : 'false' }}">
                <div class="status-icons"></div>
                <div class="battle-stage__sprite">
                    <img src="{{ asset('asset/img/combat/' ~ member.name|lower|replace({' ': '-'}) ~ '/fightidle.webp') }}" alt="{{ member.name }}" class="character-sprite" width="120" height="160">
                </div>
                <div class="hp-bar">
                    <div class="hp-bar__fill" style="width: 100%"></div>
                </div>
                <span class="hp-text">{{ member.hp }}/{{ member.hp }}</span>
                <span class="battle-stage__name">{{ member.name }}</span>
            </div>
            {% endfor %}
        </div>

        <div class="battle-stage__vs">VS</div>

        <div class="battle-stage__team battle-stage__team--right">
            {% for member in composition['Equipe 2'] %}
            <div class="battle-stage__character"
                 data-character-name="{{ member.name }}"
                 data-character-team="Equipe 2"
                 data-character-slug="{{ member.name|lower|replace({' ': '-'}) }}"
                 data-has-heal="{{ member.hasHeal ? 'true' : 'false' }}">
                <div class="status-icons"></div>
                <div class="battle-stage__sprite">
                    <img src="{{ asset('asset/img/combat/' ~ member.name|lower|replace({' ': '-'}) ~ '/fightidle.webp') }}" alt="{{ member.name }}" class="character-sprite" width="120" height="160">
                </div>
                <div class="hp-bar">
                    <div class="hp-bar__fill" style="width: 100%"></div>
                </div>
                <span class="hp-text">{{ member.hp }}/{{ member.hp }}</span>
                <span class="battle-stage__name">{{ member.name }}</span>
            </div>
            {% endfor %}
        </div>

        {# Overlay du vainqueur - couleur basee sur victoire/defaite du joueur actuel #}
        <div class="battle-stage__overlay {% if isDraw is defined and isDraw %}battle-stage__overlay--draw{% elseif userWon is defined and userWon %}battle-stage__overlay--victory{% else %}battle-stage__overlay--defeat{% endif %}"
             data-combat-overlay>
            <div class="battle-stage__winner">
                {% if isDraw is defined and isDraw %}
                    <span class="winner-text">Match Nul</span>
                {% elseif winner == 'Equipe 1' %}
                    <span class="winner-label">Victoire</span>
                    <span class="winner-text">{{ team1Name|default('Equipe 1') }}</span>
                {% elseif winner == 'Equipe 2' %}
                    <span class="winner-label">Victoire</span>
                    <span class="winner-text">{{ team2Name|default('Equipe 2') }}</span>
                {% endif %}
            </div>
        </div>
    </div>

    {# ========================================== #}
    {# SECTION BASSE - 3 colonnes               #}
    {# ========================================== #}
    <div class="battle-info">

        {# Colonne gauche - Equipe 1 (player1) #}
        <div class="info-panel info-panel--team1">
            <h2 class="info-panel__title">{{ team1Name|default('Equipe 1') }}</h2>

            {% if team1Player is defined and team1Player %}
            <div class="info-panel__player">
                <div class="info-panel__avatar">
                    {% if team1Player.profileImage %}
                        <img src="/uploads/avatars/{{ team1Player.profileImage }}" alt="Avatar de {{ team1Player.username }}">
                    {% else %}
                        <i class="fas fa-user-circle" aria-hidden="true"></i>
                    {% endif %}
                </div>
                <div class="info-panel__player-info">
                    <span class="info-panel__username">{{ team1Player.username }}</span>
                    {% if team1Player.motto %}
                        <span class="info-panel__motto">&laquo; {{ team1Player.motto|length > 40 ? team1Player.motto|slice(0, 40) ~ '...' : team1Player.motto }} &raquo;</span>
                    {% endif %}
                    <span class="info-panel__rating"><i class="fas fa-trophy"></i> {{ team1Player.rating }} MMR</span>
                </div>
            </div>
            {% endif %}

            {% if team1Synergies is defined and team1Synergies|length > 0 %}
            <div class="info-panel__synergies">
                {% for syn in team1Synergies %}
                <div class="synergy-chip">
                    <i class="fas fa-link"></i>
                    <span class="synergy-chip__name">{{ syn.name }}</span>
                    <span class="synergy-chip__chars">{{ syn.char1 }} + {{ syn.char2 }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="info-panel__characters">
                {% for member in composition['Equipe 1'] %}
                <div class="character-info" data-char-name="{{ member.name }}" data-char-team="Equipe 1">
                    <div class="character-info__icon">
                        <img src="{{ asset('asset/img/' ~ member.name|lower|replace({' ': '-'}) ~ '.webp') }}"
                             alt="{{ member.name }}"
                             class="character-info__sprite" width="60" height="60" loading="lazy">
                    </div>
                    <div class="character-info__details">
                        <div class="character-info__name">{{ member.name }}</div>
                        <div class="character-info__stats">PV: <span>{{ member.hp }}</span></div>
                        {% if member.abilityName %}
                        <div class="character-info__ability" data-ability-cd="{{ member.abilityCd }}" data-ability-max-cd="{{ member.abilityCd }}">
                            <i class="fas fa-fire-alt"></i>
                            <span class="character-info__ability-name">{{ member.abilityName }}</span>
                            <span class="character-info__ability-cd-badge" style="display:none;"></span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        {# Colonne centrale - Deroulement du combat #}
        <div class="combat-panel">
            <h2 class="combat-panel__title">Deroulement du Combat</h2>

            {# Controles #}
            <div class="combat-controls">
                <div class="combat-controls__playback">
                    <button class="btn-arena btn-arena--primary" data-combat-play>
                        Pause
                    </button>
                    <button class="btn-arena btn-arena--secondary" data-combat-skip>
                        Skip
                    </button>
                </div>
                <div class="combat-controls__speed">
                    <span class="speed-label">Vitesse:</span>
                    <button class="speed-btn active" data-combat-speed="1">x1</button>
                    <button class="speed-btn" data-combat-speed="2">x2</button>
                    <button class="speed-btn" data-combat-speed="3">x3</button>
                </div>
                <div class="combat-controls__audio">
                    <button class="audio-mute-btn" data-audio-mute title="Mute/Unmute">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <span class="audio-label"><i class="fas fa-music"></i></span>
                    <input type="range" class="audio-volume-slider" data-audio-volume
                           min="0" max="1" step="0.01" value="0.05">
                    <span class="audio-label"><i class="fas fa-bolt"></i> SFX</span>
                    <input type="range" class="audio-volume-slider" data-sfx-volume
                           min="0" max="1" step="0.01" value="0.15">
                </div>
            </div>

            <div class="combat-panel__log" data-combat-log>
                {# Les logs seront ajout√©s ici par JS #}
            </div>

            <div class="combat-panel__actions">
                <a href="{{ path('app_arena') }}" class="btn-arena btn-arena--primary">Rejouer</a>
                <a href="{{ path('app_home') }}" class="btn-arena btn-arena--secondary">Quitter</a>
            </div>
        </div>

        {# Colonne droite - Equipe 2 (player2 ou bot) #}
        <div class="info-panel info-panel--team2">
            <h2 class="info-panel__title">{{ team2Name|default('Equipe 2') }}</h2>

            {% if team2Player is defined and team2Player %}
            <div class="info-panel__player">
                <div class="info-panel__avatar info-panel__avatar--enemy">
                    {% if team2Player.profileImage %}
                        <img src="/uploads/avatars/{{ team2Player.profileImage }}" alt="Avatar de {{ team2Player.username }}">
                    {% else %}
                        <i class="fas fa-user-circle" aria-hidden="true"></i>
                    {% endif %}
                </div>
                <div class="info-panel__player-info">
                    <span class="info-panel__username">{{ team2Player.username }}</span>
                    {% if team2Player.motto %}
                        <span class="info-panel__motto">&laquo; {{ team2Player.motto|length > 40 ? team2Player.motto|slice(0, 40) ~ '...' : team2Player.motto }} &raquo;</span>
                    {% endif %}
                    <span class="info-panel__rating info-panel__rating--enemy"><i class="fas fa-trophy"></i> {{ team2Player.rating }} MMR</span>
                </div>
            </div>
            {% elseif isVsBot is defined and isVsBot %}
            <div class="info-panel__player">
                <div class="info-panel__avatar info-panel__avatar--enemy">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="info-panel__player-info">
                    <span class="info-panel__username">{{ botName|default('Bot') }}</span>
                </div>
            </div>
            {% endif %}

            {% if team2Synergies is defined and team2Synergies|length > 0 %}
            <div class="info-panel__synergies">
                {% for syn in team2Synergies %}
                <div class="synergy-chip">
                    <i class="fas fa-link"></i>
                    <span class="synergy-chip__name">{{ syn.name }}</span>
                    <span class="synergy-chip__chars">{{ syn.char1 }} + {{ syn.char2 }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="info-panel__characters">
                {% for member in composition['Equipe 2'] %}
                <div class="character-info" data-char-name="{{ member.name }}" data-char-team="Equipe 2">
                    <div class="character-info__icon">
                        <img src="{{ asset('asset/img/' ~ member.name|lower|replace({' ': '-'}) ~ '.webp') }}"
                             alt="{{ member.name }}"
                             class="character-info__sprite" width="60" height="60" loading="lazy">
                    </div>
                    <div class="character-info__details">
                        <div class="character-info__name">{{ member.name }}</div>
                        <div class="character-info__stats">PV: <span>{{ member.hp }}</span></div>
                        {% if member.abilityName %}
                        <div class="character-info__ability" data-ability-cd="{{ member.abilityCd }}" data-ability-max-cd="{{ member.abilityCd }}">
                            <i class="fas fa-fire-alt"></i>
                            <span class="character-info__ability-name">{{ member.abilityName }}</span>
                            <span class="character-info__ability-cd-badge" style="display:none;"></span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

    </div>
</div>
{% endblock %}
