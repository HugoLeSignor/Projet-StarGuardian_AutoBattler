{% extends 'base.html.twig' %}

{% block title %}Arena - Combat{% endblock %}

{% block body %}
<div class="arena-container" data-combat-logs="{{ logsJson|e('html_attr') }}"{% if battleId is defined and battleId %} data-battle-id="{{ battleId }}"{% endif %}>

    {# ========================================== #}
    {# SECTION HAUTE - Zone de combat animations #}
    {# ========================================== #}
    {% set backgrounds = ['cove.jpg', 'warrens.jpg', 'ruins.jpg', 'darkest.jpg', 'arena1.jpg', 'arena2.jpg', 'weald.webp'] %}
    {% set bg = random(backgrounds) %}
    <div class="battle-stage" style="background-image: url('{{ asset('asset/img/backgrounds/' ~ bg) }}');">
        <div class="battle-stage__team battle-stage__team--left">
            {% for member in composition['Equipe 1'] %}
            <div class="battle-stage__character"
                 data-character-name="{{ member.name }}"
                 data-character-team="Equipe 1">
                <div class="battle-stage__sprite">
                    <img src="{{ asset('asset/img/combat/' ~ member.name|lower|replace({' ': '-'}) ~ '.webp') }}" alt="{{ member.name }}" class="character-sprite">
                </div>
                <div class="hp-bar">
                    <div class="hp-bar__fill" style="width: 100%"></div>
                </div>
                <span class="hp-text">{{ member.hp }}/{{ member.hp }}</span>
                <span class="battle-stage__name">{{ member.name }}</span>
            </div>
            {% endfor %}
        </div>

        <div class="battle-stage__vs">VS</div>

        <div class="battle-stage__team battle-stage__team--right">
            {% for member in composition['Equipe 2'] %}
            <div class="battle-stage__character"
                 data-character-name="{{ member.name }}"
                 data-character-team="Equipe 2">
                <div class="battle-stage__sprite">
                    <img src="{{ asset('asset/img/combat/' ~ member.name|lower|replace({' ': '-'}) ~ '.webp') }}" alt="{{ member.name }}" class="character-sprite">
                </div>
                <div class="hp-bar">
                    <div class="hp-bar__fill" style="width: 100%"></div>
                </div>
                <span class="hp-text">{{ member.hp }}/{{ member.hp }}</span>
                <span class="battle-stage__name">{{ member.name }}</span>
            </div>
            {% endfor %}
        </div>

        {# Overlay du vainqueur #}
        <div class="battle-stage__overlay {% if winner == 'Equipe 1' %}battle-stage__overlay--team1{% elseif winner == 'Equipe 2' %}battle-stage__overlay--team2{% else %}battle-stage__overlay--draw{% endif %}"
             data-combat-overlay>
            <div class="battle-stage__winner">
                {% if winner == 'Match nul' %}
                    <span class="winner-text">Match Nul</span>
                {% elseif winner == 'Equipe 1' %}
                    <span class="winner-label">Victoire</span>
                    <span class="winner-text">{{ team1Name|default('Equipe 1') }}</span>
                {% elseif winner == 'Equipe 2' %}
                    <span class="winner-label">Victoire</span>
                    <span class="winner-text">{{ team2Name|default('Equipe 2') }}</span>
                {% endif %}
            </div>
        </div>
    </div>

    {# ========================================== #}
    {# SECTION BASSE - 3 colonnes               #}
    {# ========================================== #}
    <div class="battle-info">

        {# Colonne gauche - Profil joueur + Equipe 1 #}
        <div class="info-panel info-panel--team1">
            <h2 class="info-panel__title">{{ team1Name|default('Equipe 1') }}</h2>

            {% if app.user %}
            <div class="info-panel__player">
                <div class="info-panel__avatar">
                    {% if app.user.profileImage %}
                        <img src="/uploads/avatars/{{ app.user.profileImage }}" alt="Avatar">
                    {% else %}
                        <i class="fas fa-user-circle"></i>
                    {% endif %}
                </div>
                <div class="info-panel__player-info">
                    <span class="info-panel__username">{{ app.user.username }}</span>
                    {% if app.user.motto %}
                        <span class="info-panel__motto">&laquo; {{ app.user.motto }} &raquo;</span>
                    {% endif %}
                    <span class="info-panel__rating"><i class="fas fa-trophy"></i> {{ app.user.rating }} MMR</span>
                </div>
            </div>
            {% endif %}

            <div class="info-panel__characters">
                {% for member in composition['Equipe 1'] %}
                <div class="character-info">
                    <div class="character-info__icon">
                        <img src="{{ asset('asset/img/' ~ member.name|lower|replace({' ': '-'}) ~ '.webp') }}"
                             alt="{{ member.name }}"
                             class="character-info__sprite">
                    </div>
                    <div class="character-info__details">
                        <div class="character-info__name">{{ member.name }}</div>
                        <div class="character-info__stats">PV: <span>{{ member.hp }}</span></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        {# Colonne centrale - Deroulement du combat #}
        <div class="combat-panel">
            <h2 class="combat-panel__title">Deroulement du Combat</h2>

            {# Controles #}
            <div class="combat-controls">
                <div class="combat-controls__playback">
                    <button class="btn-arena btn-arena--primary" data-combat-play>
                        Pause
                    </button>
                    <button class="btn-arena btn-arena--secondary" data-combat-skip>
                        Skip
                    </button>
                </div>
                <div class="combat-controls__speed">
                    <span class="speed-label">Vitesse:</span>
                    <button class="speed-btn active" data-combat-speed="1">x1</button>
                    <button class="speed-btn" data-combat-speed="2">x2</button>
                    <button class="speed-btn" data-combat-speed="3">x3</button>
                </div>
            </div>

            <div class="combat-panel__log" data-combat-log>
                {# Les logs seront ajout√©s ici par JS #}
            </div>

            <div class="combat-panel__actions">
                <a href="{{ path('app_arena') }}" class="btn-arena btn-arena--primary">Rejouer</a>
                <a href="{{ path('app_home') }}" class="btn-arena btn-arena--secondary">Quitter</a>
            </div>
        </div>

        {# Colonne droite - Profil adversaire + Equipe 2 #}
        <div class="info-panel info-panel--team2">
            <h2 class="info-panel__title">{{ team2Name|default('Equipe 2') }}</h2>

            {% if opponent is defined and opponent %}
            <div class="info-panel__player">
                <div class="info-panel__avatar info-panel__avatar--enemy">
                    {% if opponent.profileImage %}
                        <img src="/uploads/avatars/{{ opponent.profileImage }}" alt="Avatar">
                    {% else %}
                        <i class="fas fa-user-circle"></i>
                    {% endif %}
                </div>
                <div class="info-panel__player-info">
                    <span class="info-panel__username">{{ opponent.username }}</span>
                    {% if opponent.motto %}
                        <span class="info-panel__motto">&laquo; {{ opponent.motto }} &raquo;</span>
                    {% endif %}
                    <span class="info-panel__rating info-panel__rating--enemy"><i class="fas fa-trophy"></i> {{ opponent.rating }} MMR</span>
                </div>
            </div>
            {% endif %}

            <div class="info-panel__characters">
                {% for member in composition['Equipe 2'] %}
                <div class="character-info">
                    <div class="character-info__icon">
                        <img src="{{ asset('asset/img/' ~ member.name|lower|replace({' ': '-'}) ~ '.webp') }}"
                             alt="{{ member.name }}"
                             class="character-info__sprite">
                    </div>
                    <div class="character-info__details">
                        <div class="character-info__name">{{ member.name }}</div>
                        <div class="character-info__stats">PV: <span>{{ member.hp }}</span></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

    </div>
</div>
{% endblock %}